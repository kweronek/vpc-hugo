// **********
// servers.tf
// **********
# resource "aws_instance" "public1" {
resource "aws_spot_instance_request" "public1" {
  count=1
  wait_for_fulfillment = true
  spot_type = "one-time"  
  ami = var.ami_id
  instance_type = var.instance_type
  spot_price = "0.01"
  key_name = var.ami_key_pair_name
  vpc_security_group_ids = [aws_security_group.ssh_all.id]
  root_block_device { volume_size = "8" }

  tags = {
    Name = "${var.env}-inst-${count.index}"
#     Name = "${var.env}-inst-1"
    AMI = var.ami_name
    Instance_type = "spot" 
  }
  subnet_id = aws_subnet.public1.id

  provisioner "local-exec" {
    command = "echo The IP address is ${self.private_ip}"
  }
}

locals { tags = {
    Name = "public1-srv-${count.index}-spot"
    AMI = "${var.ami_name}"
    Environment = "${var.env}"
}   }

resource "aws_ec2_tag" "public1" {
  resource_id = aws_spot_instance_request.public1.spot_instance_id
  for_each = local.tags
  key      = each.key
  value    = each.value
}

# resource "aws_instance" "private2" {
resource "aws_spot_instance_request" "private2" {

  wait_for_fulfillment = true
  spot_type = "one-time"
  ami = var.ami_id
  instance_type = var.instance_type
  spot_price    = "0.01"
  key_name = var.ami_key_pair_name
  vpc_security_group_ids = [aws_security_group.ssh_all.id]
  root_block_device { volume_size = "8" }

  tags = {
    Name = "${var.env}-inst-2"
    AMI  = var.ami_name  
    Instance_type = "on demand"
  }

  provisioner "local-exec" {
    command = "echo The IP address is ${self.private_ip}"
  }
  subnet_id = aws_subnet.private2.id
}

locals { tags = {
    Name = "private2-srv-${count.index}-spot"
    AMI = "${var.ami_name}"
    Environment = "${var.env}"
}   }

resource "aws_ec2_tag" "private2" {
  resource_id = aws_spot_instance_request.private2.spot_instance_id
  for_each = local.tags
  key      = each.key
  value    = each.value
}
